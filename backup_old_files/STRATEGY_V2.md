# 전략 2: Ollama + CrewAI 멀티 에이전트 전략

## 개요

온디바이스 LLM(Ollama)과 멀티 에이전트 프레임워크(CrewAI)를 활용한 AI 기반 자동매매 전략입니다.
3개의 전문 AI 에이전트가 협력하여 매매 결정을 내립니다.

## 아키텍처

```
┌─────────────────────────────────────────────────────────────────┐
│                        CrewAI Strategy                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │  Data Analyst   │  │ News Sentiment  │  │Trading Decision │ │
│  │     Agent       │→→│     Agent       │→→│     Agent       │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
│         │                     │                     │          │
│         ↓                     ↓                     ↓          │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │  기술적 분석    │  │  뉴스 감성분석  │  │  최종 매매결정  │ │
│  │  MA, RSI, MACD  │  │  네이버 금융    │  │  점수 기반 판단 │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 에이전트 구성

### 1. Data Analyst Agent (기술적 분석)
- **역할**: 시장 데이터 분석 전문가
- **분석 항목**:
  - 이동평균선 (MA5, MA20, MA60)
  - RSI (상대강도지수)
  - MACD 크로스
  - 거래량 비율
  - 가격 변동률

### 2. News Sentiment Agent (뉴스 감성 분석)
- **역할**: 뉴스 감성 분석 전문가
- **데이터 소스**: 네이버 금융 뉴스
- **분석 방법**:
  - 긍정 키워드: 상승, 급등, 신고가, 호재, 수주, 계약, 흑자 등
  - 부정 키워드: 하락, 급락, 신저가, 악재, 적자, 감소 등
- **출력**: 감성 점수 (-100 ~ +100)

### 3. Trading Decision Agent (매매 결정)
- **역할**: 최종 투자 결정
- **입력**: 기술적 분석 + 뉴스 감성 분석 결과
- **출력**: 매수/매도/관망 결정 + 종합 점수

## 종목 선정

### 스캔 대상
1. **거래량 상위 50종목**: 시장에서 활발하게 거래되는 종목
2. **기존 보유 종목**: 필수 분석 (매도 타이밍 판단)

### 필터링 조건
- 거래대금 10억원 이상
- 주가 1,000원 이상
- 상장주식수 100만주 이상

## 매매 조건

### 매수 조건
| 조건 | 기준값 | 설명 |
|------|--------|------|
| 종합 점수 | >= 60점 | 기술적 분석 + 뉴스 감성 종합 |
| RSI | 40 ~ 70 | 과매수/과매도 구간 제외 |
| MA5 돌파 | 현재가 > MA5 | 단기 상승 추세 |
| 거래량 비율 | > 150% | 평균 대비 거래량 증가 |

### 매도 조건
| 조건 | 기준값 | 설명 |
|------|--------|------|
| 익절 | +5% | 수익 실현 |
| 손절 | -3% | 손실 제한 |
| RSI 과매수 | > 75 | 과열 구간 매도 |
| MA5 이탈 | 현재가 < MA5 | 단기 추세 이탈 |
| 뉴스 부정 | > 60% | 부정적 뉴스 비율 높음 |
| 보유 기간 | > 3일 | 장기 보유 방지 |

## 설정값

```python
DEFAULT_CONFIG = {
    'scan_count': 50,        # 스캔 종목 수
    'buy_score_min': 60,     # 최소 매수 점수
    'take_profit': 5.0,      # 익절 비율 (%)
    'stop_loss': -3.0,       # 손절 비율 (%)
    'max_hold_days': 3,      # 최대 보유 기간
    'max_stocks': 5,         # 최대 보유 종목 수
    'buy_amount': 500000,    # 종목당 매수 금액
    'ollama_model': 'llama3.2',  # Ollama 모델
    'use_news': True,        # 뉴스 분석 사용
    'news_weight': 0.3       # 뉴스 점수 가중치
}
```

## 점수 계산

### 기술적 분석 점수 (70%)
```
기술점수 = (
    MA 점수 (30점) +
    RSI 점수 (25점) +
    MACD 점수 (25점) +
    거래량 점수 (20점)
)
```

### 뉴스 감성 점수 (30%)
```
뉴스점수 = 감성점수 * 0.3
(범위: -30 ~ +30)
```

### 종합 점수
```
종합점수 = 기술점수 * 0.7 + 뉴스점수 * 0.3
```

## 파일 구조

```
Pythontreade/
├── strategies/
│   ├── __init__.py
│   ├── momentum_volume_strategy.py    # 전략 1
│   ├── volatility_breakout_strategy.py
│   └── crewai_strategy.py             # 전략 2 (NEW)
├── crawlers/
│   ├── __init__.py
│   └── naver_news_crawler.py          # 뉴스 크롤러 (NEW)
├── analyzers/
│   └── ollama_analyzer.py             # Ollama 분석기
├── auto_trader.py                      # 자동매매 엔진
└── STRATEGY_V2.md                      # 이 문서
```

## 사용 방법

### 1. Ollama 설치 (선택사항)
```bash
# macOS
brew install ollama

# Linux
curl -fsSL https://ollama.com/install.sh | sh

# 모델 다운로드
ollama pull llama3.2
```

### 2. CrewAI 설치 (선택사항)
```bash
pip install crewai crewai-tools
```

### 3. 전략 실행
```python
from auto_trader import AutoTraderManager, STRATEGY_CREWAI

# 매니저 생성
manager = AutoTraderManager(api)

# CrewAI 전략으로 트레이더 생성
config = {
    'scan_count': 50,
    'buy_score_min': 60,
    'take_profit': 5.0,
    'stop_loss': -3.0,
    'max_stocks': 5,
    'buy_amount': 500000
}

manager.create_trader(
    strategy_type=STRATEGY_CREWAI,
    config=config,
    use_ollama=True
)

# 자동매매 시작
manager.start_trading(interval=60)
```

## Fallback 모드

Ollama 또는 CrewAI가 설치되지 않은 경우, 규칙 기반 분석으로 자동 전환됩니다:
- 기술적 지표 기반 점수 계산
- 키워드 기반 뉴스 감성 분석
- 동일한 매매 로직 적용

## 주의사항

1. **투자 위험**: 이 전략은 참고용이며, 투자 손실에 대한 책임은 사용자에게 있습니다.
2. **API 한도**: 네이버 금융 크롤링 시 요청 간격을 유지하세요.
3. **시스템 자원**: Ollama 실행 시 충분한 메모리(8GB+)가 필요합니다.
4. **장 운영 시간**: 한국 시장 기준 09:05 ~ 15:20 자동 실행

## 변경 이력

| 날짜 | 버전 | 내용 |
|------|------|------|
| 2025-11-25 | 1.0 | 초기 버전 - CrewAI 멀티 에이전트 전략 구현 |
